{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Identification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{% static 'styles/login.css' %}">
    <link rel="stylesheet" href="{% static 'facetest.css' %}">
</head>

<body>
    <section class="flex flex-col justify-between h-[100vh] w-full">
        <div class="flex flex-col items-center w-full">
            <div class=" ">
                <h1 class="text-[26px] md:text-[36px] font-bold mt-10">Generate Health Code</h1>
            </div>
            <div class="mt-10 text-[22px] md:text-[28px] flex flex-col items-center w-full">
                <h2>Face Identification Scan</h2>

                <main id="camera">
                    
                    <video id="camera--view" autoplay playsinline muted="true"></video>
 

            </div>

            <div class="flex flex-col items-center" id="hidecam">
                <div class="" onclick="show()">
                    <button class="rounded border bg-[#008080] w-[200px] text-white p-3 mt-6" id="camera--trigger" >Scan Face</button>
                </div>
                <div class="mt-3" id="camera--trig">
                    <p class="text-[12px] md:text-[16px]">Place your face directly into the centre of the webcam</p>
                </div>
            </div>

            <div class="hidden flex flex-col items-center" id="show">
                <canvas id="camera--sensor" class="hidden"></canvas>
                <img src="//:0" alt="" id="camera--output" />
                {% comment %} <img src="//:0" alt="" id="camera--sensor" /> {% endcomment %}
                <div class="w-[100%] md:w-[100%]" onclick="rescan()">
                    <button class="rounded border border-[#008080] w-[200px]  text-black p-3 mt-6">Scan Again</button>
                </div>
                {%csrf_token%}
                <div>
                    <button id="uploadImage" class="rounded border bg-[#008080] w-[200px]  text-white p-3 mt-6">Continue</button>
                </div>
            </div>

        </main>
        </div>
        <footer class="pl-4">
            <div>Powered by Civicnexa software ©
                <script>new Date().getFullYear() > 2017 && document.write(new Date().getFullYear());</script>
            </div>

        </footer>
    </section>
    <script src="{% static 'test.js' %}"></script>
    <script>
        document.getElementById('uploadImage').addEventListener('click', function () {
            uploadImage();
        });
    
        function getCSRFToken() {
            var csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            return csrfToken;
        }
    

        function convertBase64ToBlob(base64Data) {
            // Remove the data:image/jpeg;base64, prefix
            var base64Image = base64Data.replace(/^data:image\/jpeg;base64,/, '');
    
            // Convert to binary
            var binary = atob(base64Image);
    
            // Create a Uint8Array from the binary data
            var uint8Array = new Uint8Array(binary.length);
            for (var i = 0; i < binary.length; i++) {
                uint8Array[i] = binary.charCodeAt(i);
            }
    
            // Create a Blob from the Uint8Array
            return new Blob([uint8Array], { type: 'image/jpeg' });
        }
    
        function uploadImage() {
            var canvas = document.getElementById('camera--sensor');
            var imageSrc = canvas.toDataURL('image/jpeg', 0.8);  // Convert to JPEG with quality 0.8
            var csrfToken = getCSRFToken();
    
            // Check if the image source is not the default one
            if (imageSrc !== "data:,") {
                // Convert base64 to Blob
                var blob = convertBase64ToBlob(imageSrc);
    
                // Create a FormData object and append the Blob
                var formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken);
                formData.append('image', blob, 'uploaded_image.jpeg');
    
                // Debugging: Log the FormData content
                for (var pair of formData.entries()) {
                    console.log(pair[0] + ', ' + pair[1]);
                }
    
                // Create an XMLHttpRequest object
                var xhr = new XMLHttpRequest();
                xhr.open('POST', "{% url 'face' %}", true);
    
                // Define the onload and onerror callback functions
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        // Handle the success response
                        console.log("Image uploaded successfully");
                        // Redirect to the profile page
                        window.location.href = "{% url 'profile' %}";
                    } else {
                        // Handle error responses
                        console.error("Error uploading image");
                    }
                };
    
                xhr.onerror = function () {
                    // Handle network errors
                    console.error("Network error");
                };
    
                // Send the FormData object containing the image data
                xhr.send(formData);
            } else {
                console.log("No image to upload");
            }
        }
    </script>
        <footer class="pl-4">
            <div>Powered by Civicnexa software ©
                <script>new Date().getFullYear() > 2017 && document.write(new Date().getFullYear());</script>
            </div>

        </footer>
    </section>
</body>

</html>